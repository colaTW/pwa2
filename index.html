<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>即時停車場狀態</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    h1 { color: #333; }
    .lot { margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; cursor: move; }
    .error { color: red; font-weight: bold; }
    .drag-over { background-color: #d3eafd !important; }

    #lot-container {
      max-width: 400px;
    }
  </style>
</head>
<body>
  <h1>即時停車場剩餘車位</h1>
  <div id="lot-container"></div>
  <div id="error" class="error"></div>

  <script>
    const mockData = [
      { id: 1, name: "台北停車場", ps: 5 },
      { id: 2, name: "台中停車場", ps: 3 },
      { id: 3, name: "台南停車場", ps: 8 },
      { id: 4, name: "高雄停車場", ps: 2 },
      { id: 5, name: "新竹停車場", ps: 6 }
    ];

    const container = document.getElementById("lot-container");

    function setCookie(name, value, days) {
      const d = new Date();
      d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = name + "=" + value + ";expires=" + d.toUTCString() + ";path=/";
    }

    function getCookie(name) {
      const match = document.cookie.match(new RegExp(name + "=([^;]+)"));
      return match ? decodeURIComponent(match[1]) : "";
    }

    function renderLots(data) {
      container.innerHTML = "";
      data.forEach(item => {
        const div = document.createElement("div");
        div.className = "lot";
        div.draggable = true;
        div.dataset.id = item.id;
        div.innerText = `${item.name} - 剩餘車位 ${item.ps}`;
        container.appendChild(div);
      });
      addDragAndDrop();
    }

    function addDragAndDrop() {
      const items = document.querySelectorAll('.lot');
      let dragSrcEl = null;

      items.forEach(item => {
        item.addEventListener('dragstart', (e) => {
          dragSrcEl = item;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', item.outerHTML);
          item.classList.add('dragging');
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          item.classList.add('drag-over');
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          item.classList.remove('drag-over');
          if (dragSrcEl !== item) {
            container.removeChild(dragSrcEl);
            const dropHTML = e.dataTransfer.getData('text/html');
            item.insertAdjacentHTML('beforebegin', dropHTML);
            const newItem = container.querySelector('.dragging');
            newItem.classList.remove('dragging');
            addDragAndDrop();
            saveCurrentOrder();
          }
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
        });
      });
    }

    function saveCurrentOrder() {
      const ids = Array.from(document.querySelectorAll('.lot')).map(div => div.dataset.id);
      setCookie('lotOrder', ids.join(','), 365);
    }

    function loadOrder(data) {
      const order = getCookie('lotOrder');
      if (!order) return data;
      const idOrder = order.split(',').map(Number);
      const map = new Map(data.map(item => [item.id, item]));
      return idOrder.map(id => map.get(id)).filter(Boolean);
    }

    // 初始化
    const orderedData = loadOrder(mockData);
    renderLots(orderedData);
  </script>
</body>
</html>
